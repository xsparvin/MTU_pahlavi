<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MTU Tester by xsparvin (Static)</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');

:root {
  --bg: linear-gradient(135deg, #0a101f, #151c30);
  --card: rgba(24, 35, 61, 0.95);
  --text: #e0e9ff;
  --muted: #a1b2c9;
  --accent: #00e0ff;
  --accent-secondary: #ff00e0;
  --glow-color: rgba(0, 224, 255, 0.7);
  --glow-secondary: rgba(255, 0, 224, 0.7);
  --glass: rgba(255,255,255,0.15);
  --input-bg: rgba(0,0,0,0.5);
  --shadow: 0 16px 50px rgba(0,0,0,0.8), 0 0 25px var(--glow-color);
  --border-radius: 28px;
  --transition: all 0.3s ease-out; /* Transition simplified for less movement */
  --font-en: "Inter", sans-serif;
  --font-fa: "Vazirmatn", sans-serif;
}

body.light-theme {
  --bg: linear-gradient(135deg, #f0f4ff, #d9e3ff);
  --card: rgba(255,255,255,0.98);
  --text: #1a202c;
  --muted: #64748b;
  --accent: #0066ff;
  --accent-secondary: #d600b6;
  --glow-color: rgba(0,102,255,0.5);
  --glow-secondary: rgba(214,0,182,0.5);
  --glass: rgba(0,0,0,0.1);
  --input-bg: #f8fafc;
  --shadow: 0 16px 50px rgba(0,0,0,0.15), 0 0 25px var(--glow-color);
}

body {
  margin: 0; padding: 32px;
  font-family: var(--font-fa);
  background: var(--bg); color: var(--text);
  min-height: 100vh; transition: var(--transition);
  overflow-x: hidden; position: relative;
}

/* Background Animation REMOVED */
body::before {
  content:''; position:absolute; top:0; left:0; width:100%; height:100%;
  background: radial-gradient(circle at 50% 50%, var(--glow-color), transparent 60%);
  opacity: 0.15;
  pointer-events: none; z-index:-1; 
  /* animation: pulse REMOVED */
}
/* Keyframes pulse REMOVED */

.wrap { max-width: 900px; margin: 0 auto; position: relative; z-index: 1; }

h1 {
  font-size: 36px; margin: 0 0 28px; font-weight: 900; color: var(--accent);
  text-shadow: 0 0 15px var(--glow-color), 0 0 5px var(--glow-secondary);
  text-align: center;
  /* animation: neon-glow REMOVED */
}
/* Keyframes neon-glow REMOVED */

.card {
  background: var(--card); border: 2px solid var(--glass); 
  padding: 32px;
  border-radius: var(--border-radius); box-shadow: var(--shadow);
  backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
  margin-bottom: 32px; transition: var(--transition);
}
.card:hover {
    /* Transform REMOVED */
    box-shadow: var(--shadow); /* Keep shadow static */
}

label { display: block; font-size: 14px; color: var(--muted); margin-bottom: 8px; font-weight: 700; }

input[type="text"], input[type="number"] {
  width: 100%; padding: 14px; border-radius: 16px; background: var(--input-bg);
  border: 1px solid var(--glass); color: var(--text); font-size: 16px; font-family: 'Inter', sans-serif;
  box-sizing: border-box; text-align: left; direction: ltr; transition: all 0.2s ease-out;
}
input:focus {
  outline: none; border-color: var(--accent);
  box-shadow: 0 0 15px var(--glow-color), inset 0 0 5px var(--glow-color);
  background: rgba(255,255,255,0.08);
}

button {
  padding: 14px 24px; border-radius: 14px; border: none; cursor: pointer;
  background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
  color: #fff; font-weight: 800; transition: all 0.2s ease-out;
  position: relative; overflow: hidden; font-family: var(--font-fa); font-size: 15px;
}
button:hover:not(:disabled) { 
    /* Transform REMOVED */
    box-shadow: 0 0 15px var(--glow-color); /* Simplified hover effect */
}
/* Shimmer effect REMOVED */
button::after { content: none; }
/* Active transform REMOVED */
button:active:not(:disabled) { transform: none; }
button:disabled { 
    opacity: 0.5; cursor: wait; 
    filter: grayscale(80%); 
    transform: none;
    box-shadow: none;
}

#auto { background: var(--glass); border: 1px solid var(--muted); color: var(--text); }
#auto:hover:not(:disabled) { background: rgba(255,255,255,0.2); border-color: var(--accent); }

#clear { background: transparent; border: 1px solid #ff5555; color: #ff5555; }
#clear:hover { background: rgba(255, 85, 85, 0.15); box-shadow: 0 0 15px rgba(255,85,85,0.7); }

.live-box {
  margin-top: 24px; border: 1px solid var(--glass); border-radius: 16px;
  padding: 20px; background: rgba(0,0,0,0.3); 
  min-height: 100px; 
  display: flex; flex-direction: column; justify-content: center;
  align-items: center; 
}
.live-box strong { margin-bottom: 8px; color: var(--accent); }
.status { 
    font-size: 17px; margin-top: 8px; font-weight: bold; 
    min-height: 20px; 
    text-align: center;
}
.status-loading { color: #facc15; /* animation: blink REMOVED */ }
/* Keyframes blink REMOVED */

.status-ok { color: #4ade80; text-shadow: 0 0 10px rgba(74, 222, 128, 0.6); }
.status-err { color: #f87171; text-shadow: 0 0 10px rgba(248, 113, 113, 0.6); }

table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 24px; font-size: 14px; }
th, td { padding: 12px 16px; border-bottom: 1px solid var(--glass); text-align: center; }
th { color: var(--muted); font-weight: 600; }
tr:last-child td { border-bottom: none; }
tr:nth-child(even) { background: rgba(255,255,255,0.02); }
tr:hover { background: rgba(255,255,255,0.08) !important; transition: none; }

/* Table Container for Fixed Height */
#tableContainer {
    max-height: 300px; 
    overflow-y: auto; 
    margin-top: 20px;
    border-radius: 16px;
    border: 1px solid var(--glass);
    box-shadow: inset 0 0 15px rgba(0,0,0,0.3);
}
#tableContainer table { margin-top: 0; }
#tableContainer thead th { position: sticky; top: 0; background: var(--card); z-index: 10; border-bottom: 2px solid var(--accent); }


/* Code Block */
pre {
  background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px;
  overflow-x: auto; color: var(--accent); border: 1px solid var(--glass);
  font-family: 'Courier New', monospace; direction: ltr; text-align: left; font-size: 13px;
}

/* Controls */
.controls { display: flex; justify-content: space-between; margin-bottom: 24px; }
.control-btn {
  padding: 10px 18px; border-radius: 14px; background: var(--glass);
  color: var(--text); cursor: pointer; font-size: 14px; border: 1px solid var(--glass);
  transition: 0.2s ease-out; /* Reduced transition time */
  display: flex; align-items: center; gap: 8px; 
}
.control-btn:hover { background: rgba(255,255,255,0.25); border-color: var(--accent); }

.button-group { display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap; }
.button-group button { flex: 1; min-width: 140px; }

footer { margin-top: 40px; text-align: center; color: var(--muted); font-size: 13px; }
footer a { color: var(--accent); text-decoration: none; }

/* New Input Group Style */
.input-group {
    display: flex;
    gap: 12px;
    margin-top: 16px;
}
.input-group > div {
    flex: 1;
}

/* Responsive */
@media(max-width: 600px) {
  body { padding: 16px; }
  .button-group { flex-direction: column; }
  h1 { font-size: 24px; }
  .input-group { flex-direction: column; }
}

/* Lang specific fonts */
body[dir="ltr"] { font-family: var(--font-en); }
body[dir="rtl"] { font-family: var(--font-fa); }
</style>
</head>
<body class="">

<div class="wrap">
  <div class="controls">
    <div id="languageToggle" class="control-btn">ğŸŒ EN / FA</div>
    <div id="themeToggle" class="control-btn">ğŸ’¡ / ğŸŒ™</div>
  </div>

  <h1 id="appTitle">ØªØ³ØªØ± Ù¾ÛŒØ´Ø±ÙØªÙ‡ MTU</h1>

  <div class="card">
    <label id="labelService">Ø¢Ø¯Ø±Ø³ Ø³Ø±ÙˆÛŒØ³ (Payload Generator URL)</label>
    <input id="serviceURL" type="text" value="https://httpbin.org/bytes/" dir="ltr" />
    
    <div class="input-group">
       <div style="flex:1;">
           <label id="labelSize">Ø³Ø§ÛŒØ² Ø¨Ø³ØªÙ‡ (Ø¨Ø§ÛŒØª) - ØªØ³Øª ØªÚ©ÛŒ</label>
           <input id="size" type="number" value="1472" dir="ltr" />
       </div>
    </div>
    
    <hr style="margin: 20px 0; border-color: var(--glass);" />

    <h4 style="color:var(--accent); margin-bottom: 12px;">ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªØ³Øª Ø®ÙˆØ¯Ú©Ø§Ø± (Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¨Ø§ÛŒÙ†Ø±ÛŒ)</h4>
    <div class="input-group">
        <div>
           <label id="labelMinSize">Ø´Ø±ÙˆØ¹ Ø¬Ø³ØªØ¬Ùˆ (Min Payload)</label>
           <input id="minSize" type="number" value="500" dir="ltr" />
        </div>
        <div>
           <label id="labelMaxSize">Ù¾Ø§ÛŒØ§Ù† Ø¬Ø³ØªØ¬Ùˆ (Max Payload)</label>
           <input id="maxSize" type="number" value="1500" dir="ltr" />
        </div>
    </div>


    <div class="button-group">
      <button id="run">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª ØªÚ©ÛŒ</button>
      <button id="auto">ØªØ³Øª Ø®ÙˆØ¯Ú©Ø§Ø± (Ù‡ÙˆØ´Ù…Ù†Ø¯)</button>
      <button id="clear">Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ</button>
    </div>

    <div class="live-box">
      <strong id="strongStatus">ÙˆØ¶Ø¹ÛŒØª Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ:</strong>
      <div id="liveStatus" class="status" style="color:var(--muted)">Ù…Ù†ØªØ¸Ø± Ø¯Ø³ØªÙˆØ±...</div>
      <div id="testCounter" style="font-size:13px; color:var(--muted); margin-top: 5px;"></div>
    </div>

    <div id="tableContainer">
        <table id="results">
          <thead><tr><th id="thSize">Ø³Ø§ÛŒØ²</th><th id="thResult">Ù†ØªÛŒØ¬Ù‡</th><th id="thTime">Ø²Ù…Ø§Ù† (ms)</th></tr></thead>
          <tbody></tbody>
        </table>
    </div>
  </div>

  <div class="card">
    <h3 id="h3Accurate">Ø¯Ø³ØªÙˆØ±Ø§Øª Ø¯Ù‚ÛŒÙ‚ MTU (Ø±ÙˆØ´ Ø³ÛŒØ³ØªÙ…ÛŒ)</h3>
    <p id="pAccurate" style="font-size:14px; color:var(--muted); line-height:1.6;">
      Ø§ÛŒÙ† Ø§Ø¨Ø²Ø§Ø± Ù…Ø¨ØªÙ†ÛŒ Ø¨Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø³Øª Ùˆ Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø®Ø§Øµ Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø§Ø±Ø¯. Ø¨Ø±Ø§ÛŒ ØªØ¹ÛŒÛŒÙ† Ø¯Ù‚ÛŒÙ‚ MTU Ø¨Ø¯ÙˆÙ† ÙØ±Ø§Ú¯Ù…Ù†Øª Ø´Ø¯Ù† (DF)ØŒ Ø¨Ù‡ØªØ±ÛŒÙ† Ø±Ø§Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ±Ù…ÛŒÙ†Ø§Ù„ Ø³ÛŒØ³ØªÙ… Ø¹Ø§Ù…Ù„ Ø§Ø³Øª:
    </p>
    <pre>
Windows:
ping -f -l &lt;SIZE&gt; google.com

Linux / Android Terminal:
ping -M do -s &lt;SIZE&gt; google.com

macOS:
ping -D -s &lt;SIZE&gt; google.com

Formula: Real MTU = Max Payload + 28
    </pre>
    
    <div id="summaryBox" style="margin-top:20px; padding:15px; background:rgba(255,255,255,0.05); border-radius:12px; border: 1px solid var(--glass); display:none;">
        <h4 style="margin:0 0 10px 0; color:var(--accent);">ğŸ“Š Ù†ØªØ§ÛŒØ¬ ØªØ­Ù„ÛŒÙ„</h4>
        <div id="summaryText"></div>
    </div>
  </div>

  <footer>
    Made with â¤ï¸ by xsparvin | <a href="https://t.me/xsfsociety" target="_blank">Channel</a>
  </footer>
</div>

<script>
// --- State & Config (No functional changes) ---
const state = {
    lang: localStorage.getItem('mtu_lang') || 'fa',
    theme: localStorage.getItem('mtu_theme') || 'dark',
    isRunning: false,
    results: [],
    testCount: 0
};

const translations = {
    fa: {
        appTitle: "ØªØ³ØªØ± Ù¾ÛŒØ´Ø±ÙØªÙ‡ MTU",
        labelService: "Ø¢Ø¯Ø±Ø³ Ø³Ø±ÙˆÛŒØ³ ØªØ³Øª (Payload Generator)",
        labelSize: "Ø³Ø§ÛŒØ² Ø¨Ø³ØªÙ‡ (Ø¨Ø§ÛŒØª) - ØªØ³Øª ØªÚ©ÛŒ",
        labelMinSize: "Ø´Ø±ÙˆØ¹ Ø¬Ø³ØªØ¬Ùˆ (Min Payload)",
        labelMaxSize: "Ù¾Ø§ÛŒØ§Ù† Ø¬Ø³ØªØ¬Ùˆ (Max Payload)",
        run: "Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª ØªÚ©ÛŒ",
        auto: "ØªØ³Øª Ø®ÙˆØ¯Ú©Ø§Ø± (Ù‡ÙˆØ´Ù…Ù†Ø¯)",
        clear: "Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù†ØªØ§ÛŒØ¬",
        strongStatus: "ÙˆØ¶Ø¹ÛŒØª Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ:",
        waiting: "Ù…Ù†ØªØ¸Ø± Ø¯Ø³ØªÙˆØ±...",
        testing: "Ø¯Ø±Ø­Ø§Ù„ ØªØ³Øª {n} Ø¨Ø§ÛŒØª...",
        success: "Ù…ÙˆÙÙ‚",
        failed: "Ù†Ø§Ù…ÙˆÙÙ‚",
        timeout: "Timeout",
        error: "Ø®Ø·Ø§",
        thSize: "Ø³Ø§ÛŒØ²",
        thResult: "Ù†ØªÛŒØ¬Ù‡",
        thTime: "Ø²Ù…Ø§Ù† (ms)",
        h3Accurate: "Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ù‚ÛŒÙ‚ MTU (Ø±ÙˆØ´ ØªØ±Ù…ÛŒÙ†Ø§Ù„)",
        pAccurate: "Ù…Ø±ÙˆØ±Ú¯Ø±Ù‡Ø§ Ø§Ø¬Ø§Ø²Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø¨Ø³ØªÙ‡ ICMP ÙˆØ§Ù‚Ø¹ÛŒ Ø±Ø§ Ù†Ù…ÛŒâ€ŒØ¯Ù‡Ù†Ø¯. Ø§ÛŒÙ† Ø§Ø¨Ø²Ø§Ø± Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¯Ø§Ø¯Ù‡ Ø¯Ø± Ø­Ø¬Ù…â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù Ø±Ø§ ØªØ³Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ø¨Ø±Ø§ÛŒ MTU Ø¯Ù‚ÛŒÙ‚ Ù„Ø§ÛŒÙ‡ Ø´Ø¨Ú©Ù‡ Ø§Ø² Ø¯Ø³ØªÙˆØ±Ø§Øª Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯:",
        summaryHeader: "ğŸ“Š Ù†ØªØ§ÛŒØ¬ ØªØ­Ù„ÛŒÙ„",
        summaryResult: `Ø¨Ø²Ø±Ú¯ØªØ±ÛŒÙ† Ø¨Ø³ØªÙ‡ Ù…ÙˆÙÙ‚: <strong>{max} Ø¨Ø§ÛŒØª</strong><br>MTU Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ (ØªØ®Ù…ÛŒÙ†): <strong>{mtu}</strong><br><span style="font-size:13px; font-weight:normal;">{classification}</span>`,
        stop: "ØªÙˆÙ‚Ù ØªØ³Øª",
        counter: "ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡: {current} Ø§Ø² {total} (ØªØ®Ù…ÛŒÙ†)",
        class_std: "ÙˆØ¶Ø¹ÛŒØª: ğŸŸ¢ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø§ØªØ±Ù†Øª (1500)",
        class_jumbo: "ÙˆØ¶Ø¹ÛŒØª: ğŸŸ  Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø² Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ (Jumbo Frame ÛŒØ§ Ù…Ø´Ú©Ù„ Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ)",
        class_small: "ÙˆØ¶Ø¹ÛŒØª: ğŸ”´ Ø¨Ø³ÛŒØ§Ø± Ú©ÙˆÚ†Ú© (Ø§Ø­ØªÙ…Ø§Ù„ ÙˆØ¬ÙˆØ¯ ÙØ§ÛŒØ±ÙˆØ§Ù„ ÛŒØ§ Ù…Ø´Ú©Ù„ Fragmentation)"
    },
    en: {
        appTitle: "Advanced MTU Tester",
        labelService: "Test Service URL (Payload Generator)",
        labelSize: "Payload Size (bytes) - Single Test",
        labelMinSize: "Start Search (Min Payload)",
        labelMaxSize: "End Search (Max Payload)",
        run: "Run Single Test",
        auto: "Auto Test (Binary Search)",
        clear: "Clear Results",
        strongStatus: "Live Status:",
        waiting: "Ready...",
        testing: "Testing {n} bytes...",
        success: "Success",
        failed: "Failed",
        timeout: "Timeout",
        error: "Error",
        thSize: "Size",
        thResult: "Result",
        thTime: "Time (ms)",
        h3Accurate: "Accurate MTU Check (Terminal)",
        pAccurate: "Browsers cannot send real ICMP packets with DF flag. This tool tests HTTP payload stability. For precise Network Layer MTU, use these commands:",
        summaryHeader: "ğŸ“Š Analysis Results",
        summaryResult: `Max Successful Payload: <strong>{max} bytes</strong><br>Estimated Optimal MTU: <strong>{mtu}</strong><br><span style="font-size:13px; font-weight:normal;">{classification}</span>`,
        stop: "Stop Test",
        counter: "Tests completed: {current} of {total} (approx)",
        class_std: "Status: ğŸŸ¢ Standard Ethernet (1500)",
        class_jumbo: "Status: ğŸŸ  Higher than standard (Jumbo Frame or Routing Issue)",
        class_small: "Status: ğŸ”´ Very small (Possible Firewall or Fragmentation Issue)"
    }
};

// --- DOM Elements (Same as before) ---
const el = (id) => document.getElementById(id);
const ui = {
    appTitle: el('appTitle'),
    labelService: el('labelService'),
    labelSize: el('labelSize'),
    labelMinSize: el('labelMinSize'),
    labelMaxSize: el('labelMaxSize'),
    serviceURL: el('serviceURL'),
    sizeInput: el('size'),
    minSizeInput: el('minSize'),
    maxSizeInput: el('maxSize'),
    runBtn: el('run'),
    autoBtn: el('auto'),
    clearBtn: el('clear'),
    statusText: el('liveStatus'),
    testCounter: el('testCounter'),
    tableBody: el('results').querySelector('tbody'),
    thSize: el('thSize'),
    thResult: el('thResult'),
    thTime: el('thTime'),
    h3Accurate: el('h3Accurate'),
    pAccurate: el('pAccurate'),
    summaryBox: el('summaryBox'),
    summaryText: el('summaryText')
};

// --- Initialization (Same as before) ---
function init() {
    setTheme(state.theme);
    setLang(state.lang);
    
    el('themeToggle').onclick = toggleTheme;
    el('languageToggle').onclick = toggleLang;
    ui.runBtn.onclick = runSingleTest;
    ui.autoBtn.onclick = runAutoTest;
    ui.clearBtn.onclick = clearResults;
}

// --- Theme & Lang Logic (Same as before) ---
function setTheme(theme) {
    state.theme = theme;
    localStorage.setItem('mtu_theme', theme);
    if (theme === 'light') document.body.classList.add('light-theme');
    else document.body.classList.remove('light-theme');
}

function toggleTheme() {
    setTheme(state.theme === 'dark' ? 'light' : 'dark');
}

function setLang(lang) {
    state.lang = lang;
    localStorage.setItem('mtu_lang', lang);
    document.body.dir = lang === 'fa' ? 'rtl' : 'ltr';
    document.documentElement.lang = lang;
    
    const t = translations[lang];
    ui.appTitle.innerText = t.appTitle;
    ui.labelService.innerText = t.labelService;
    ui.labelSize.innerText = t.labelSize;
    ui.labelMinSize.innerText = t.labelMinSize;
    ui.labelMaxSize.innerText = t.labelMaxSize;
    ui.runBtn.innerText = state.isRunning ? t.stop : t.run;
    ui.autoBtn.innerText = state.isRunning ? t.stop : t.auto;
    ui.clearBtn.innerText = t.clear;
    el('strongStatus').innerText = t.strongStatus;
    ui.statusText.innerText = state.isRunning ? ui.statusText.innerText : t.waiting;
    ui.testCounter.innerText = '';
    ui.thSize.innerText = t.thSize;
    ui.thResult.innerText = t.thTime;
    ui.thTime.innerText = t.thTime;
    ui.h3Accurate.innerText = t.h3Accurate;
    ui.pAccurate.innerText = t.pAccurate;
}

function toggleLang() {
    setLang(state.lang === 'fa' ? 'en' : 'fa');
}

// --- Core Testing Logic (All functions are the same as the previous version) ---

async function fetchPayload(size) {
    const url = ui.serviceURL.value;
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000); 

    const start = performance.now();
    try {
        const targetUrl = `${url}${size}?_t=${Date.now()}`;
        const response = await fetch(targetUrl, { 
            signal: controller.signal,
            cache: "no-store",
            mode: 'cors' 
        });
        
        clearTimeout(timeoutId);
        const end = performance.now();
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const blob = await response.blob();
        if (blob.size !== parseInt(size)) throw new Error("Size Mismatch");

        return { success: true, time: (end - start).toFixed(0) };
    } catch (err) {
        return { success: false, error: err.name === 'AbortError' ? 'Timeout' : err.message };
    }
}

function logResult(size, result) {
    const tr = document.createElement('tr');
    const t = translations[state.lang];
    
    let statusHtml = '';

    if (result.success) {
        statusHtml = `<span class="res-success">âœ” ${t.success}</span>`;
    } else {
        const msg = result.error === 'Timeout' ? t.timeout : t.failed;
        statusHtml = `<span class="res-fail">âœ˜ ${msg}</span>`;
    }

    tr.innerHTML = `
        <td style="font-family:monospace; font-weight:bold;">${size}</td>
        <td>${statusHtml}</td>
        <td dir="ltr">${result.time ? result.time : '-'}</td>
    `;
    
    ui.tableBody.prepend(tr);
    
    ui.statusText.innerHTML = result.success ? 
        `<span class="status-ok">${t.success}: ${size} bytes</span>` : 
        `<span class="status-err">${t.failed}: ${size} bytes</span>`;

    return result.success;
}

async function runSingleTest() {
    if (state.isRunning) return stopTest();
    
    const size = parseInt(ui.sizeInput.value);
    if (!size || size < 1) return alert('Invalid size');

    setRunningState(true);
    const t = translations[state.lang];
    ui.statusText.innerText = t.testing.replace('{n}', size);
    ui.statusText.className = 'status status-loading';

    const result = await fetchPayload(size);
    logResult(size, result);
    setRunningState(false);
}

async function runAutoTest() {
    if (state.isRunning) return stopTest();

    let min = parseInt(ui.minSizeInput.value) || 500;
    let max = parseInt(ui.maxSizeInput.value) || 1500;
    
    if (min >= max || min < 1 || max > 9000) {
        alert('Ù„Ø·ÙØ§Ù‹ Ø¨Ø§Ø²Ù‡ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø¹ØªØ¨Ø±ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Max Ø¨Ø§ÛŒØ¯ Ø¨Ø²Ø±Ú¯ØªØ± Ø§Ø² Min Ø¨Ø§Ø´Ø¯ Ùˆ Max Ø§Ø² 9000 Ø¨ÛŒØ´ØªØ± Ù†Ø¨Ø§Ø´Ø¯).');
        return;
    }

    setRunningState(true);
    ui.tableBody.innerHTML = ''; 
    let optimalPayload = 0;
    
    const totalTests = Math.ceil(Math.log2(max - min)) + 1;
    state.testCount = 0; 
    
    const t = translations[state.lang];

    let currentMin = min;
    let currentMax = max;

    while (currentMin <= currentMax && state.isRunning) {
        let mid = Math.floor((currentMin + currentMax) / 2);
        
        state.testCount++;
        ui.statusText.innerText = t.testing.replace('{n}', mid);
        ui.statusText.className = 'status status-loading';
        ui.testCounter.innerText = t.counter.replace('{current}', state.testCount).replace('{total}', totalTests);
        
        let success = await doTestStep(mid);
        
        if (success) {
            optimalPayload = mid;
            currentMin = mid + 1;
        } else {
            currentMax = mid - 1;
        }
        
        await new Promise(r => setTimeout(r, 500));
    }

    if (state.isRunning) {
        showSummary(optimalPayload);
        ui.testCounter.innerText = '';
        setRunningState(false);
    }
}

async function doTestStep(size) {
    const result = await fetchPayload(size);
    logResult(size, result);
    return result.success;
}

function getClassification(mtu, lang) {
    const t = translations[lang];
    if (mtu > 1528) {
        return t.class_jumbo;
    } else if (mtu <= 1500 && mtu >= 1400) {
        return t.class_std;
    } else if (mtu < 1400) {
        return t.class_small;
    }
    return '';
}

function showSummary(maxPayload) {
    if(maxPayload === 0) return;
    
    const t = translations[state.lang];
    ui.summaryBox.style.display = 'block';
    
    const estimatedMTU = maxPayload + 28; 
    
    const classificationText = getClassification(estimatedMTU, state.lang);
    
    ui.summaryText.innerHTML = t.summaryResult
        .replace('{max}', maxPayload)
        .replace('{mtu}', estimatedMTU)
        .replace('{classification}', classificationText);
}

function setRunningState(running) {
    state.isRunning = running;
    const t = translations[state.lang];
    
    if (running) {
        ui.runBtn.innerText = t.stop;
        ui.autoBtn.innerText = t.stop;
        ui.runBtn.style.background = '#ff5555';
        ui.autoBtn.style.background = '#ff5555';
        ui.sizeInput.disabled = true;
        ui.serviceURL.disabled = true;
        ui.minSizeInput.disabled = true;
        ui.maxSizeInput.disabled = true;
    } else {
        ui.runBtn.innerText = t.run;
        ui.autoBtn.innerText = t.auto;
        ui.runBtn.style.background = ''; 
        ui.autoBtn.style.background = '';
        ui.sizeInput.disabled = false;
        ui.serviceURL.disabled = false;
        ui.minSizeInput.disabled = false;
        ui.maxSizeInput.disabled = false;
        ui.statusText.innerText = t.waiting;
        ui.statusText.className = 'status';
        ui.testCounter.innerText = '';
    }
}

function stopTest() {
    setRunningState(false);
    ui.statusText.innerText = "Stopped by user.";
}

function clearResults() {
    ui.tableBody.innerHTML = '';
    ui.summaryBox.style.display = 'none';
    ui.statusText.innerText = translations[state.lang].waiting;
    ui.testCounter.innerText = '';
}

// Start
init();

</script>
</body>
</html>


